---

title: Elasticsearch


keywords: fastai
sidebar: home_sidebar



nb_path: "01_Get_Articles_Data.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_Get_Articles_Data.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center><strong style="font-size:40px">Articles Extraction</strong></center>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_config" class="doc_header"><code>read_config</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L26" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_config</code>(<strong><code>json_path</code></strong>:<code>str</code>=<em><code>'config.json'</code></em>)</p>
</blockquote>
<p>Read json config file</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>json_path: str, optional
    Path to the project json config file. Default is to use the one found at root directory</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>dict
    with the data contained in the config file.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Connection">Connection<a class="anchor-link" href="#Connection"> </a></h2><p>This is a convenient function to establish connection with the Elastic search database using the project config file</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="es_connect" class="doc_header"><code>es_connect</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L48" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>es_connect</code>(<strong><code>config</code></strong>:<code>dict</code>, <strong><code>host_name</code></strong>:<code>str</code>=<em><code>'prod'</code></em>, <strong><code>add_index</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Establish connection to the project's elasticsearch</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>config : dict
    Project config dictionary
host_name : str
    name of the host to connect to; should be defined in config</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>ElasticSearch Client
     ElasticSearch Client to the project es instance</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="es_document_summary_stats" class="doc_header"><code>es_document_summary_stats</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L72" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>es_document_summary_stats</code>(<strong><code>es_client</code></strong>:<code>Elasticsearch</code>, <strong><code>config</code></strong>:<code>dict</code>, <strong><code>start_date</code></strong>:<code>str</code>, <strong><code>end_date</code></strong>:<code>str</code>, <strong><code>date_field_name</code></strong>:<code>str</code>=<em><code>'extracted_date'</code></em>, <strong><code>field_name</code></strong>:<code>str</code>=<em><code>'language'</code></em>, <strong><code>field_val</code></strong>:<code>Optional</code>[<code>List</code>[<code>T</code>]]=<em><code>[]</code></em>, <strong><code>aggreg_field_name</code></strong>:<code>Optional</code>[<code>str</code>]=<em><code>None</code></em>, <strong><code>index_type</code></strong>:<code>str</code>=<em><code>'articles'</code></em>)</p>
</blockquote>
<p>Gives summary statistics based on time range and field of choice for either mentions or articles</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>es_client: Elasticsearch
config : dict
    Project config dictionary
date_field_name : str
    Takes the exact name of the date field on which range needs to be applied to. Default
    to "extracted_date"
start_date : str ; end_date : str
    Takes the start and end date to determine the timeline to fetch articles in YYYY-mm-dd format
field_name : str
    The field on which the grouping has to be done, Default is language for nutch-* (mentions) index
field_val : list, optional
    The list of values of the particular field that we will be filtering on
aggreg_field_name: str, optional
    The field name we will make an aggregation on
index_type: str
    name of the index we will send the request to. Should be defined in the
    'config["elastic_search"]["indexes"]'. Currently accepted values
    are <code>articles</code> or <code>mentions</code>.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>pandas.DataFrame
     Returns a pandas.DataFrame with 2 columns: <code>field_name</code> and <code>count</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Get-name-commonness-score">Get name commonness score<a class="anchor-link" href="#Get-name-commonness-score"> </a></h1><ol>
<li>The name commonness score function <strong><em>get_common_rank</em></strong> returns the score for a name</li>
<li>Get the name score for all the entity names obtained in <strong><em>df_entity_mention</em></strong> data frame</li>
<li>Save the scored dataframe as pickle</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_common_rank" class="doc_header"><code>get_common_rank</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L161" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_common_rank</code>(<strong><code>name</code></strong>)</p>
</blockquote>
<p>Gives name commonness score for an entity name</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>name: The entity name we want to get the score for</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>scrore: A name rank score for the entity name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Get-the-Common-Names-for-Test-set">Get the Common Names for Test set<a class="anchor-link" href="#Get-the-Common-Names-for-Test-set"> </a></h1><ol>
<li>Import the pickle file with containing the mention count and commonness score</li>
<li>Filter all names with <strong><em>score &gt;= 1e-7</em></strong></li>
<li>Randomly select 1000 names from the dataframe and the list of names <strong><em>names_list</em></strong> are the names of choice</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Get-all-the-Articles-for-the-common-names-selected-randomly">Get all the Articles for the common names selected randomly<a class="anchor-link" href="#Get-all-the-Articles-for-the-common-names-selected-randomly"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_document_es" class="doc_header"><code>get_document_es</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L188" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_document_es</code>(<strong><code>es_client</code></strong>:<code>Elasticsearch</code>, <strong><code>config</code></strong>:<code>dict</code>, <strong><code>query</code></strong>:<code>dict</code>, <strong><code>fields</code></strong>:<code>Optional</code>[<code>List</code>[<code>T</code>]]=<em><code>[]</code></em>, <strong><code>index_type</code></strong>:<code>str</code>=<em><code>'articles'</code></em>, <strong><code>date_field_name</code></strong>:<code>str</code>=<em><code>'tstamp'</code></em>, <strong><code>date</code></strong>:<code>Optional</code>[<code>str</code>]=<em><code>''</code></em>, <strong><code>start_date</code></strong>:<code>Optional</code>[<code>str</code>]=<em><code>''</code></em>, <strong><code>end_date</code></strong>:<code>Optional</code>[<code>str</code>]=<em><code>''</code></em>)</p>
</blockquote>
<p>Gives one document either article or mentions based on id from elastic search</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>es_client: Elasticsearch
config : dict
    Project config dictionary
query : dict
    Takes the exact id of the document which needs to be fetched, it can
    be any other unique key in the document
fields : List, optional
    Fields we want to be returned
index_type: str
    name of the index we will send the request to. Should be defined in the
    'config["elastic_search"]["indexes"]'. Currently accepted values
    are <code>articles</code> or <code>mentions</code>.
date : str, optiona
    if provided, search would be restricted for the given date.
    Date format is expected to be in %YYYY-mm-dd</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>List of dict
    List of dictionaries where each dictionary represents the info returned by one document</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="keep_article" class="doc_header"><code>keep_article</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L261" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>keep_article</code>(<strong><code>article_uri</code></strong>:<code>str</code>, <strong><code>es_client</code></strong>:<code>Elasticsearch</code>, <strong><code>config</code></strong>:<code>dict</code>, <strong><code>index_type</code></strong>:<code>str</code>=<em><code>'articles'</code></em>, <strong><code>dates_check</code></strong>:<code>Optional</code>[<code>List</code>[<code>T</code>]]=<em><code>[]</code></em>)</p>
</blockquote>
<p>Keep an article if the <code>article_uri</code> has a uniuqe content in the database</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>article_uri : str
    The article uri
es_client: Elasticsearch
config : dict
    Project config dictionary
index_type: str
    name of the index we will send the request to. Should be defined in the
    'config["elastic_search"]["indexes"]'. Currently accepted values
    are <code>articles</code> or <code>mentions</code>.
dates_check: List[str], optional
    dates to check in YYYY-mm-dd format. If not empty, the test is to check that the url
    has only one occurence in the provided list</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>dict
    keep: Wether the article should be kept or not
    info: Info extratced to make the <code>keep</code> decision</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="encode" class="doc_header"><code>encode</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L311" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>encode</code>(<strong><code>input_str</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Enforce <code>input</code> encoding to utf-8</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>input_str: str
    input string to encode</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>str
    Same as <code>input</code> string with utf-8 encoding enforced</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_articles" class="doc_header"><code>get_articles</code><a href="https://git.uk/machine-learning/data-science-and-statistical-learning/am_combiner/tree/master/am_combiner/articles.py#L333" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_articles</code>(<strong><code>entity_name</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Get the details of all articles (url,content) for a given entity name</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>entity_name : str
    The name of the entity for whom the details needs to be fetched</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>dataframe:
    contain the following details for an entity
    snippet: snippet of extracted mentions
    extracted_date: date of mention extraction
    uri: the uri of the mention
    _id: id of the mention
    date_range: a range of dates (2 days before mention extracted date) to check if the url belongs
                in a certain date range
    keep_article: Whether the article should be kept or not
    title : title of the article for the uri
    content : content of the article for the uri</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

